name: Package CurseForge ZIP

permissions:
  contents: write

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag name for the release (e.g. v0.5.3)"
        required: false
      test_only:
        description: "Test ZIP generation only (no release)"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"

jobs:
  test:
    uses: ./.github/workflows/test-reusable.yml

  package:
    needs: test
    runs-on: ubuntu-latest
    # Only run if tests passed
    if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'push' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Subversion
        run: sudo apt-get update && sudo apt-get install -y subversion

      - name: Download Libraries
        run: |
          mkdir -p libs libs_test
          
          # SVN libraries
          svn checkout https://repos.curseforge.com/wow/ace3/trunk/AceComm-3.0 libs/AceComm-3.0 --quiet
          svn checkout https://repos.curseforge.com/wow/ace3/trunk/AceGUI-3.0 libs/AceGUI-3.0 --quiet
          svn checkout https://repos.curseforge.com/wow/ace3/trunk/AceSerializer-3.0 libs/AceSerializer-3.0 --quiet
          svn checkout https://repos.curseforge.com/wow/callbackhandler/trunk/CallbackHandler-1.0 libs/CallbackHandler-1.0 --quiet
          svn checkout https://repos.curseforge.com/wow/libdbicon-1-0/trunk libs/LibDBIcon-1.0 --quiet
          svn checkout https://repos.curseforge.com/wow/libstub/trunk libs/LibStub --quiet
          
          # Git libraries
          git clone https://repos.curseforge.com/wow/libdatabroker-1-1 libs/LibDataBroker-1.1 --quiet
          git clone https://github.com/SafeteeWoW/LibDeflate libs/LibDeflate --quiet
          cd libs/LibDeflate && git checkout 1.0.2-release --quiet && cd ../..

      - name: Clean Library Development Files
        run: |
          # Remove version control directories
          find libs -type d -name ".svn" -exec rm -rf {} + 2>/dev/null || true
          find libs -type d -name ".git" -exec rm -rf {} + 2>/dev/null || true
          find libs -type d -name ".github" -exec rm -rf {} + 2>/dev/null || true
          
          # Remove test directories
          find libs -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true
          find libs -type d -name "test" -exec rm -rf {} + 2>/dev/null || true
          
          # Remove documentation and examples
          find libs -type d -name "docs" -exec rm -rf {} + 2>/dev/null || true
          find libs -type d -name "examples" -exec rm -rf {} + 2>/dev/null || true
          
          # Remove CI/build files
          find libs -name ".travis.yml" -delete 2>/dev/null || true
          find libs -name ".appveyor.yml" -delete 2>/dev/null || true
          find libs -name ".luacheckrc" -delete 2>/dev/null || true
          find libs -name ".pkgmeta" -delete 2>/dev/null || true
          find libs -name "*.rockspec" -delete 2>/dev/null || true
          find libs -name ".gitignore" -delete 2>/dev/null || true
          
          # Remove README and changelog files
          find libs -name "README*" -delete 2>/dev/null || true
          find libs -name "readme*" -delete 2>/dev/null || true
          find libs -name "CHANGELOG*" -delete 2>/dev/null || true
          find libs -name "changelog*" -delete 2>/dev/null || true
          find libs -name "LICENSE*" -delete 2>/dev/null || true
          
          # Remove embedded duplicate libraries from LibDBIcon (we load our own versions)
          rm -rf libs/LibDBIcon-1.0/LibStub 2>/dev/null || true
          rm -rf libs/LibDBIcon-1.0/CallbackHandler-1.0 2>/dev/null || true
          rm -rf libs/LibDBIcon-1.0/LibDataBroker-1.1 2>/dev/null || true
          rm -f libs/LibDBIcon-1.0/embeds.xml 2>/dev/null || true
          rm -f libs/LibDBIcon-1.0/LibDBIcon-1.0.toc 2>/dev/null || true
          
          echo "Cleaned library development files"
      - name: Build ZIP (git archive + export-ignore)
        run: |
          set -euo pipefail

          ADDON_NAME="BookArchivist"
          VERSION="${GITHUB_REF_NAME:-dev-$(git rev-parse --short HEAD)}"

          mkdir -p dist

          # Create temporary directory
          tmpdir="$(mktemp -d)"
          
          # Export git-tracked files
          git archive --format=tar --prefix="${ADDON_NAME}/" HEAD | tar -x -C "$tmpdir"
          
          # Copy libs folder (downloaded separately, not from git archive)
          cp -rv libs "$tmpdir/${ADDON_NAME}/"
          
          # Verify libs were copied
          echo "Checking libs in archive:"
          ls -la "$tmpdir/${ADDON_NAME}/libs/"
          
          # Create ZIP
          (cd "$tmpdir" && zip -qr "${GITHUB_WORKSPACE}/dist/${ADDON_NAME}.zip" "${ADDON_NAME}")
          
          # Verify ZIP was created
          if [ ! -f "dist/${ADDON_NAME}.zip" ]; then
            echo "ERROR: ZIP file was not created."
            exit 1
          fi
          
          echo "ZIP created successfully: dist/${ADDON_NAME}.zip"
          ls -lh "dist/${ADDON_NAME}.zip"

      - name: Process TOC replacements (CurseForge tokens)
        run: |
          set -euo pipefail

          ADDON_NAME="BookArchivist"
          ZIP="dist/${ADDON_NAME}.zip"
          
          # Extract version from tag or commit hash
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF_NAME#v}"  # Strip 'v' prefix from tag
          else
            VERSION="dev-$(git rev-parse --short HEAD)"
          fi

          tmpdir="$(mktemp -d)"
          unzip -q "$ZIP" -d "$tmpdir"

          toc_path="$tmpdir/${ADDON_NAME}/${ADDON_NAME}.toc"
          if [ ! -f "$toc_path" ]; then
            echo "TOC file not found at $toc_path"
            exit 1
          fi

          # Replace @project-version@ token
          sed -i "s/@project-version@/${VERSION}/g" "$toc_path"
          echo "Replaced @project-version@ with ${VERSION}"

          rm -f "$ZIP"
          (cd "$tmpdir" && zip -qr "${GITHUB_WORKSPACE}/dist/${ADDON_NAME}.zip" "${ADDON_NAME}")
          
          # Verify TOC exists in final ZIP
          ZIP="dist/${ADDON_NAME}.zip"
          if ! unzip -l "$ZIP" | grep -qE " ${ADDON_NAME}/BookArchivist\.toc$"; then
            echo "ERROR: Missing ${ADDON_NAME}/BookArchivist.toc in zip"
            unzip -l "$ZIP"
            exit 1
          fi

      - name: Prepare artifact folder
        run: |
          set -euo pipefail
          mkdir -p artifact
          unzip -q dist/BookArchivist.zip -d artifact

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: BookArchivist
          path: artifact/

      - name: Extract release notes from CHANGELOG
        if: (startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.test_only != 'true'))
        id: changelog
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          
          # Extract the section for this version from CHANGELOG.md
          awk -v ver="$VERSION" '
            /^## \[/ {
              if (found) exit;
              if ($0 ~ "\\[" ver "\\]") {
                found=1;
                print;
                next;
              }
            }
            found && /^## \[/ { exit }
            found { print }
          ' CHANGELOG.md > release_notes.md
          
          # Check if we extracted anything
          if [ ! -s release_notes.md ]; then
            echo "No changelog entry found for version $VERSION"
            echo "Release $VERSION" > release_notes.md
          fi
          
          cat release_notes.md

      - name: Create GitHub Release and upload ZIP
        if: (startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.test_only != 'true'))
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}
          name: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref_name, '-alpha') || contains(github.ref_name, '-beta') }}
          files: dist/BookArchivist.zip
