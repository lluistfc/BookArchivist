name: Reusable Test Workflow

on:
  workflow_call: {}

jobs:
  test:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Lua installation
        id: cache-lua
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/.lua
          key: lua-5.1-windows-${{ runner.os }}-${{ hashFiles('.github/workflows/test-reusable.yml') }}

      - name: Setup MSVC
        if: steps.cache-lua.outputs.cache-hit != 'true'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Setup Lua 5.1
        if: steps.cache-lua.outputs.cache-hit != 'true'
        uses: leafo/gh-actions-lua@v10
        with:
          luaVersion: "5.1"

      - name: Add Lua to PATH
        run: |
          $luaBin = Join-Path $env:GITHUB_WORKSPACE ".lua\bin"
          $luaLib = Join-Path $env:GITHUB_WORKSPACE ".lua\lib"
          "$luaBin" | Out-File -FilePath $env:GITHUB_PATH -Append
          "$luaLib" | Out-File -FilePath $env:GITHUB_PATH -Append
        shell: pwsh

      - name: Cache LuaRocks binary
        id: cache-luarocks-bin
        uses: actions/cache@v4
        with:
          path: C:\luarocks-3.11.1-windows-64
          key: luarocks-3.11.1-windows-64

      - name: Install make
        run: choco install make -y
        shell: pwsh

      - name: Download LuaRocks
        if: steps.cache-luarocks-bin.outputs.cache-hit != 'true'
        run: |
          Invoke-WebRequest -Uri "https://luarocks.github.io/luarocks/releases/luarocks-3.11.1-windows-64.zip" -OutFile luarocks.zip
          Expand-Archive luarocks.zip -DestinationPath C:\
        shell: pwsh

      - name: Add LuaRocks to PATH
        run: |
          "C:\luarocks-3.11.1-windows-64" | Out-File -FilePath $env:GITHUB_PATH -Append
        shell: pwsh

      - name: Cache LuaRocks packages
        id: cache-luarocks-packages
        uses: actions/cache@v4
        with:
          path: C:\Users\runneradmin\AppData\Roaming\luarocks
          key: luarocks-packages-lua-5.1-busted-2.3.0-${{ hashFiles('.github/workflows/test-reusable.yml') }}

      - name: Configure LuaRocks
        if: steps.cache-luarocks-packages.outputs.cache-hit != 'true'
        run: |
          $luaPath = (Get-Command lua.exe).Source
          $luaDir = Split-Path $luaPath
          $luaRoot = Split-Path $luaDir
          $luaIncDir = Join-Path $luaRoot "include"
          $luaLibDir = Join-Path $luaRoot "lib"
          luarocks config --lua-version 5.1 variables.LUA "$luaPath"
          luarocks config --lua-version 5.1 variables.LUA_DIR "$luaDir"
          luarocks config --lua-version 5.1 variables.LUA_INCDIR "$luaIncDir"
          luarocks config --lua-version 5.1 variables.LUA_LIBDIR "$luaLibDir"
          luarocks config --lua-version 5.1 lua_version "5.1"
        shell: pwsh

      - name: Install Busted
        if: steps.cache-luarocks-packages.outputs.cache-hit != 'true'
        run: luarocks --lua-version 5.1 install busted
        shell: pwsh

      - name: Configure Lua paths
        run: |
          $luaLib = Join-Path $env:GITHUB_WORKSPACE ".lua\lib"
          $env:PATH = "$luaLib;$env:PATH"
          $luaRocksBin = Join-Path $env:APPDATA "luarocks\bin"
          $env:PATH = "$luaRocksBin;$env:PATH"
          "$luaRocksBin" | Out-File -FilePath $env:GITHUB_PATH -Append
          $luaPath = (luarocks --lua-version 5.1 path --lr-path 2>&1 | Out-String).Trim()
          $luaCPath = (luarocks --lua-version 5.1 path --lr-cpath 2>&1 | Out-String).Trim()
          $env:LUA_PATH = "$luaPath;;"
          $env:LUA_CPATH = "$luaCPath;;"
          "LUA_PATH=$($env:LUA_PATH)" | Out-File -FilePath $env:GITHUB_ENV -Append
          "LUA_CPATH=$($env:LUA_CPATH)" | Out-File -FilePath $env:GITHUB_ENV -Append
          busted --version
        shell: pwsh

      - name: Cache Libraries
        id: cache-libs
        uses: actions/cache@v4
        with:
          path: |
            libs
            libs_test
          key: addon-libs-${{ hashFiles('.pkgmeta') }}-v1

      - name: Install Subversion
        if: steps.cache-libs.outputs.cache-hit != 'true'
        run: |
          choco install svn -y
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          "C:\Program Files (x86)\Subversion\bin" | Out-File -FilePath $env:GITHUB_PATH -Append
        shell: pwsh

      - name: Download Libraries
        if: steps.cache-libs.outputs.cache-hit != 'true'
        run: make download-libs
        shell: pwsh

      - name: Run Tests
        run: make test-errors
        shell: pwsh

      - name: Test Summary
        if: always()
        run: |
          echo "## Test Results" >> $env:GITHUB_STEP_SUMMARY
          echo "Platform: windows-latest" >> $env:GITHUB_STEP_SUMMARY
          echo "Status: ${{ job.status }}" >> $env:GITHUB_STEP_SUMMARY
